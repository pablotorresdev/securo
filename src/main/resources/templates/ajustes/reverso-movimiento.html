<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Devolución Unidad de movimiento</title>
    <!-- Bootstrap para estilos rápidos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Metadatos CSRF provistos por Spring Security/Thymeleaf -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">Devolución Unidad de movimiento</h2>
    <!--
      Formulario principal:
      - POST a /ajustes/reverso-movimiento
      - th:object enlaza campos con movimientoDTO (binding servidor <-> vista)
    -->
    <form method="post" th:action="@{/ajustes/reverso-movimiento}" th:object="${movimientoDTO}">
        <!-- Token CSRF en el body para validar la solicitud -->
        <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>

        <hr class="my-4">
        <h5 class="mb-3 text-primary">Datos Obligatorios</h5>

        <!--
          Selector de Lotes:
          - th:field="*{codigoLote}" bindea la selección al DTO
          - Cada option muestra datos del lote para ayudar al usuario a elegir
        -->
        <div class="mb-3">
            <label class="form-label" for="codigoLote">Lote:</label>
            <select class="form-select" id="codigoLote" required th:field="*{codigoLote}">
                <option value="">-- Seleccione un Lote --</option>
                <option th:each="loteDTO : ${loteReversoDTOs}"
                        th:text="'Producto: ' + ${loteDTO.nombreProducto}
                         + ' | Codigo interno: ' + ${loteDTO.codigoLote}
                         + ' | Producto: ' + ${loteDTO.getNombreProducto()}
                         + ' | Estado: ' + ${loteDTO.getEstado()}
                         + ' | Fecha ingreso: ' + ${loteDTO.fechaIngreso}
                         + ' | Rango Trazas: ' + ${loteDTO.trazaInicial}
                         + '/' + ${loteDTO.trazaFinal}"
                        th:value="${loteDTO.codigoLote}">
                </option>
            </select>
        </div>

        <!--
          Wrapper del movimiento a revertir:
          - Muestra un resumen del último movimiento del lote elegido
          - Incluye un hidden con el código del movimiento origen que se envía al backend
          - Por defecto oculto; se muestra si hay error en 'codigoMovimientoOrigen' o cuando JS carga datos
        -->
        <div class="mb-3" id="wrapperMovajustes"
             th:style="${#fields.hasErrors('codigoMovimientoOrigen')}? '' : 'display:none;'">
            <label class="form-label" for="movResumen">Movimiento a revertir:</label>
            <input class="form-control" id="movResumen" type="text" readonly
                   placeholder="Se mostrará el último movimiento del lote seleccionado"/>
            <!-- Hidden que viaja al backend (binding con *{codigoMovimientoOrigen}) -->
            <input type="hidden" id="codigoMovimientoOrigen" th:field="*{codigoMovimientoOrigen}"/>

            <!-- Mensaje de error server-side para el movimiento origen -->
            <div class="text-danger fw-bold mt-2"
                 th:errors="*{codigoMovimientoOrigen}"
                 th:if="${#fields.hasErrors('codigoMovimientoOrigen')}">
            </div>
        </div>

        <!--
          Fecha del reverso:
          - Campo hidden (type="date") bindeado a *{fechaMovimiento}
          - Se setea por JS a hoy si no viene en el DTO
        -->
        <div class="mb-2">
            <input class="form-control" id="fechaMovimiento" name="fechaMovimiento"
                   hidden
                   th:classappend="${#fields.hasErrors('fechaMovimiento')} ? ' error-field' : ''"
                   th:field="*{fechaMovimiento}"
                   type="date">
        </div>

        <!--
          Observaciones:
          - Nota: el label dice "opcional", pero el textarea tiene required.
            Si realmente es opcional, quitá el atributo 'required'.
        -->
        <div class="mb-3">
            <label class="form-label" for="observaciones">Observaciones (opcional):</label>
            <textarea class="form-control"
                      required
                      id="observaciones"
                      rows="2"
                      th:field="*{observaciones}"></textarea>
        </div>

        <!-- Acciones -->
        <div class="d-flex justify-content-between mt-4">
            <a class="btn btn-secondary" th:href="@{/ajustes/cancelar}">Cancelar</a>
            <button class="btn btn-primary" type="submit">Realizar devolución</button>
        </div>
    </form>
</div>

<!-- Pie de página simple -->
<footer class="text-center mt-4 text-muted">
    <p>&copy; 2025 Conitrack. All rights reserved.</p>
</footer>

<!--
  Lógica de interfaz (JS):
  - Carga el último movimiento del lote seleccionado (vía fetch)
  - Rellena el resumen y el hidden 'codigoMovimientoOrigen'
  - Setea fecha por defecto (hoy, zona horaria Buenos Aires)
  - Restaura estado previo si el servidor devolvió validaciones con errores
-->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', async function () {
        // Base del contexto (resuelve @{/})
        const base = /*[[@{/}]]*/ '';
        // Elementos de la UI
        const loteSelect = document.getElementById('codigoLote');

        const movWrapper = document.getElementById('wrapperMovajustes');
        const movResumen = document.getElementById('movResumen');
        const movHidden = document.getElementById('codigoMovimientoOrigen');

        // Restauración de estado (cuando se vuelve con errores del servidor)
        const selectedCodLote = /*[[${movimientoDTO.codigoLote}]]*/ null;
        const selectedCodMov = /*[[${movimientoDTO.codigoMovimientoOrigen}]]*/ null;

        // Construye una línea de resumen legible del movimiento
        function formatResumen(mov) {
            // Nota: 'mov.fechaMovimiento ?? mov.fechaMovimiento' está duplicado;
            // se conserva para no alterar lógica; probablemente querías otro campo como 'mov.fechaCreacion'.
            const fechaMovimiento = mov.fechaMovimiento ?? mov.fechaMovimiento ?? '';
            const tipo = mov.tipoMovimiento ?? '';
            const motivo = mov.motivo ?? '';
            const cant = mov.cantidad ?? '';
            const um = mov.unidadMedida ?? '';
            const cod = mov.codigoMovimiento ?? '';
            return `Fecha de movimiento: ${fechaMovimiento} | Tipo: ${tipo} | Motivo: ${motivo} | Cant: ${cant} ${um} | Código: ${cod}`;
        }

        // Consulta el último movimiento del lote y actualiza el UI/hidden
        async function loadMovimiento(codLote, preselectCodigoMov) {
            // Oculta wrapper y limpia valores previos
            movWrapper.style.display = 'none';
            movResumen.value = '';
            movHidden.value = '';

            if (!codLote) return;

            const url = base + 'movimientos/ultimo-movimiento/' + encodeURIComponent(codLote);
            try {
                const resp = await fetch(url, {method: 'GET'});
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();

                // Normalización defensiva: objeto -> [obj], array -> array, null/undefined -> []
                const lista = Array.isArray(data) ? data : (data ? [data] : []);

                // Elección del movimiento a mostrar:
                // - Si se indicó 'preselectCodigoMov', intenta ese; si no, toma el primero
                let mov = null;
                if (preselectCodigoMov) {
                    mov = lista.find(m => m.codigoMovimiento === preselectCodigoMov) || null;
                }
                if (!mov) mov = lista[0] || null;

                // Si no hay movimiento para ese lote, no se muestra nada
                if (!mov) {
                    return;
                }

                // Rellenar resumen visible e input hidden
                movResumen.value = formatResumen(mov);
                movHidden.value = mov.codigoMovimiento || '';
                movWrapper.style.display = 'block';

            } catch (e) {
                console.error('Error movimiento:', e);
                alert('No se pudo cargar el movimiento para ese lote.');
            }
        }

        // Evento: al cambiar el lote, busca y muestra el último movimiento a revertir
        loteSelect.addEventListener('change', async () => {
            // al cambiar el lote: buscar el último movimiento
            await loadMovimiento(loteSelect.value, null, []);
        });

        // Seteo de fecha por defecto (hoy) si no viene desde el DTO
        const fechaMovimientoDTO = /*[[${movimientoDTO.fechaMovimiento}]]*/ null;
        const fechaInput = document.getElementById("fechaMovimiento");
        fechaInput.value = fechaMovimientoDTO || new Date().toLocaleDateString("en-CA", {timeZone: "America/Argentina/Buenos_Aires"});

        // Restauración automática: si ya venía lote/movimiento seleccionados, recarga el resumen
        if (selectedCodLote) {
            await loadMovimiento(selectedCodLote, selectedCodMov);
        }

        // Enfocar el primer campo con error (si lo hubiera)
        const errorField = document.querySelector('.error-field');
        if (errorField) errorField.focus();
    });
</script>
</body>
</html>
