<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ingreso de Stock y Distribución de Bultos</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">Ingreso de Stock por Compra</h2>
    <form method="post" th:action="@{/compras/ingreso-compra}" th:object="${loteDTO}">
        <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>

        <hr class="my-4">
        <h4 class="mb-3 text-primary">Datos Obligatorios</h4>
        <div class="mb-2">
            <label class="form-label" for="fechaIngreso">Fecha de Ingreso:</label>
            <input class="form-control" id="fechaIngreso" required th:field="*{fechaIngreso}" type="date">
            <div class="text-danger" th:errors="*{fechaIngreso}" th:if="${#fields.hasErrors('fechaIngreso')}"></div>
        </div>

        <div class="mb-2">
            <label class="form-label" for="productoId">Producto:</label>
            <select class="form-select" id="productoId" required th:field="*{productoId}">
                <option value="">-- Seleccione un producto --</option>
                <option th:attr="data-unit=${producto.unidadMedida}"
                        th:each="producto : ${productos}"
                        th:text="'Producto: ' + ${producto.nombreGenerico}
                         + ' | Tipo: ' + ${producto.tipoProducto}
                         + ' | Grupo: ' + ${producto.tipoProducto.getGrupo()}
                         + ' | Codigo Interno: ' + ${producto.codigoInterno}
                         + (${producto.productoDestino} != null ? ' | Producto destino: ' + ${producto.productoDestino} : '')"
                        th:value="${producto.id}"></option>
            </select>
            <div class="text-danger" th:errors="*{productoId}" th:if="${#fields.hasErrors('productoId')}"></div>
        </div>

        <div class="row mb-3 align-items-end">
            <div class="col-md-6">
                <label class="form-label" for="cantidadInicial">Cantidad:</label>
                <input class="form-control" id="cantidadInicial" required step="0.0001" th:field="*{cantidadInicial}" type="number">
                <div class="text-danger" th:errors="*{cantidadInicial}" th:if="${#fields.hasErrors('cantidadInicial')}"></div>
            </div>
            <div class="col-md-3">
                <label class="form-label" for="unidadMedida">Unidad de Medida:</label>
                <select class="form-select" id="unidadMedida" required th:field="*{unidadMedida}">
                    <option value="">-- Seleccione unidad --</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label" for="bultosTotales">Cantidad de Bultos Totales (1 a 15):</label>
                <input class="form-control" id="bultosTotales" max="15" min="1" required th:field="*{bultosTotales}" type="number">
                <div class="text-danger" th:errors="*{bultosTotales}" th:if="${#fields.hasErrors('bultosTotales')}"></div>
            </div>
        </div>

        <div class="mb-2">
            <label class="form-label" for="proveedorId">Proveedor:</label>
            <select class="form-select" id="proveedorId" required th:field="*{proveedorId}">
                <option value="">-- Seleccione un proveedor --</option>
                <option th:each="proveedor : ${proveedores}"
                        th:text="${proveedor.razonSocial}"
                        th:value="${proveedor.id}"></option>
            </select>
            <div class="text-danger" th:errors="*{proveedorId}" th:if="${#fields.hasErrors('proveedorId')}"></div>
        </div>

        <div class="mb-2">
            <label class="form-label" for="loteProveedor">Lote Proveedor:</label>
            <input class="form-control" id="loteProveedor" required th:field="*{loteProveedor}" type="text">
        </div>

        <!-- ========================================================= -->
        <!-- Bloque: Distribución de Bultos -->
        <!-- Se muestra solo si bultosTotales > 1 -->
        <!-- ========================================================= -->
        <div class="hidden" id="distribucionBultos">
            <hr class="my-4">
            <h4 class="mb-3 text-primary">Distribución de Cantidades para los Bultos</h4>
            <p>La suma de las cantidades de cada bulto debe ser igual a la cantidad total ingresada.</p>
            <div id="bultosContainer"></div>
            <div class="text-danger" th:errors="*{cantidadesBultos}" th:if="${#fields.hasErrors('cantidadesBultos')}"></div>
        </div>

        <!-- ========================================================= -->
        <!-- Sección: Datos Opcionales -->
        <!-- ========================================================= -->
        <hr class="my-4">
        <h4 class="mb-3 text-primary">Datos Opcionales</h4>
        <div class="mb-2">
            <label class="form-label" for="nroRemito">Número de Remito:</label>
            <input class="form-control" id="nroRemito" maxlength="30" th:field="*{nroRemito}" type="text">
        </div>

        <div class="mb-2">
            <label class="form-label" for="fabricanteId">Fabricante:</label>
            <select class="form-select" id="fabricanteId" th:field="*{fabricanteId}">
                <option value="">-- Seleccione un fabricante --</option>
                <option th:each="fabricante : ${proveedores}"
                        th:text="${fabricante.razonSocial}"
                        th:value="${fabricante.id}"></option>
            </select>
            <div class="text-danger" th:errors="*{fabricanteId}" th:if="${#fields.hasErrors('fabricanteId')}"></div>
        </div>

        <div class="mb-2">
            <label class="form-label" for="paisOrigen">Pais Origen</label>
            <select class="form-select" id="paisOrigen" th:field="*{paisOrigen}">
                <option value="">-- Seleccione el pais de origen --</option>
                <option th:each="pais : ${paises}"
                        th:text="${pais}"
                        th:value="${pais}"></option>
            </select>
            <div class="text-danger" th:errors="*{paisOrigen}" th:if="${#fields.hasErrors('paisOrigen')}"></div>
        </div>

        <div class="mb-2">
            <label class="form-label" for="fechaReanalisisProveedor">Fecha Re Analisis Proveedor:</label>
            <input class="form-control" id="fechaReanalisisProveedor" th:field="*{fechaReanalisisProveedor}" type="date">
            <div class="text-danger" th:errors="*{fechaReanalisisProveedor}" th:if="${#fields.hasErrors('fechaReanalisisProveedor')}"></div>
        </div>

        <div class="mb-2">
            <label class="form-label" for="fechaVencimientoProveedor">Fecha Vencimiento Proveedor:</label>
            <input class="form-control" id="fechaVencimientoProveedor" th:field="*{fechaVencimientoProveedor}" type="date">
            <div class="text-danger" th:errors="*{fechaVencimientoProveedor}" th:if="${#fields.hasErrors('fechaVencimientoProveedor')}"></div>
        </div>

        <div class="mb-2">
            <label class="form-label" for="detalleConservacion">Detalle de Conservación:</label>
            <textarea class="form-control" id="detalleConservacion" th:field="*{detalleConservacion}"></textarea>
        </div>

        <div class="mb-2">
            <label class="form-label" for="observaciones">Observaciones:</label>
            <textarea class="form-control" id="observaciones" th:field="*{observaciones}"></textarea>
        </div>

        <!-- ========================================================= -->
        <!-- Botones: Cancelar y Guardar -->
        <!-- ========================================================= -->
        <div class="d-flex justify-content-between mt-3">
            <a class="btn btn-secondary" th:href="@{/compras/cancelar}">Cancelar</a>
            <button class="btn btn-primary" type="submit">Guardar</button>
        </div>
    </form>
</div>

<!-- Pie de página -->
<footer class="text-center p-3 mt-4" style="color: #aaa;">
    <p>&copy; 2025 Conitrack. All rights reserved.</p>
</footer>

<!-- ========================================================= -->
<!-- JavaScript: Carga de subunidades y generación dinámica de campos de bultos -->
<!-- Se asegura de que al cargar la página se repoblen los valores del DTO -->
<!-- ========================================================= -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {

        // Tokens CSRF para las peticiones
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

        var fechaIngresoDTO = /*[[${loteDTO.fechaIngreso}]]*/ [];
        if (fechaIngresoDTO) {
            document.getElementById("fechaIngreso").value = fechaIngresoDTO;
        } else {
            const hoy = new Date();
            const hoyFormateado = hoy.toISOString().split('T')[0]; // Formato yyyy-MM-dd
            document.getElementById("fechaIngreso").value = hoyFormateado;
        }

        var fechaReanalisisProveedorDTO = /*[[${loteDTO.fechaReanalisisProveedor != null ? loteDTO.fechaReanalisisProveedor : '[]'}]]*/ [];
        if (fechaReanalisisProveedorDTO) {
            document.getElementById("fechaReanalisisProveedor").value = fechaReanalisisProveedorDTO;
        }
        var fechaVencimientoProveedorDTO = /*[[${loteDTO.fechaVencimientoProveedor != null ? loteDTO.fechaVencimientoProveedor : '[]'}]]*/ [];
        if (fechaVencimientoProveedorDTO) {
            document.getElementById("fechaVencimientoProveedor").value = fechaVencimientoProveedorDTO;
        }

        // Referencia al select de unidad de medida principal
        const unidadSelect = document.getElementById('unidadMedida');

        function cargarUnidadesCompatibles(unidadBase) {
            if (!unidadBase) return;
            fetch('/enums/unidades-compatibles?unidad=' + unidadBase, {
                method: 'GET',
                headers: {[csrfHeader]: csrfToken}
            })
                .then(response => response.json())
                .then(data => {
                    unidadSelect.innerHTML = '<option value="">-- Seleccione unidad --</option>';
                    data.forEach(unidad => {
                        const option = document.createElement('option');
                        option.value = unidad;
                        option.textContent = unidad;
                        if (unidad === unidadBase) option.selected = true;
                        unidadSelect.appendChild(option);
                    });
                })
                .catch(error => console.error("Error al cargar unidades:", error));
        }

        const unidadActual = /*[[${loteDTO.unidadMedida}]]*/ 'UNIDAD';
        cargarUnidadesCompatibles(unidadActual);


        const bultosContainer = document.getElementById('bultosContainer'); // Contenedor donde se crearán los campos
        // Actualiza el select principal cuando el producto cambia
        document.getElementById('productoId').addEventListener('change', function () {
            const unidadBase = this.options[this.selectedIndex].getAttribute('data-unit');
            cargarUnidadesCompatibles(unidadBase);
            // También actualiza los selects de los bultos si existen
            const selectsBultos = bultosContainer.querySelectorAll('select');
            selectsBultos.forEach(select => {
                cargarSubunidades(unidadBase, select);
            });
        });

        function cargarSubunidades(unidadBase, selectElement, preselected) {
            if (!unidadBase) return;
            fetch('/enums/subunidades?unidad=' + unidadBase, {
                method: 'GET',
                headers: {[csrfHeader]: csrfToken}
            })
                .then(response => response.json())
                .then(data => {
                    selectElement.innerHTML = '<option value="">-- Seleccione unidad --</option>';
                    data.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u;
                        option.textContent = u;
                        // Si se pasó un valor preseleccionado, se lo marca; de lo contrario, usa la unidad base
                        if (preselected) {
                            if (u === preselected) option.selected = true;
                        } else {
                            if (u === unidadBase) option.selected = true;
                        }
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => console.error("Error al cargar subunidades:", error));
        }


        var unidadMedidaBultosDTO = /*[[${loteDTO.unidadMedidaBultos != null ? loteDTO.unidadMedidaBultos : '[]'}]]*/ [];
        var cantidadesBultosDTO = /*[[${loteDTO.cantidadesBultos != null ? loteDTO.cantidadesBultos : '[]'}]]*/ [];

        function generarCamposBultos(cantidad) {
            bultosContainer.innerHTML = ''; // Limpiar campos previos
            // Se obtiene la unidad actual del select principal para usarla al cargar subunidades
            const unidadBaseBultos = unidadSelect.value || unidadActual;
            for (let i = 1; i <= cantidad; i++) {
                // --- Creación de la fila para el bulto ---
                const divRow = document.createElement('div');
                divRow.className = 'row mb-3 align-items-end';

                // --- Campo: Cantidad para el bulto ---
                const divCantidad = document.createElement('div');
                divCantidad.className = 'col-md-6';
                const labelCantidad = document.createElement('label');
                labelCantidad.className = 'form-label';
                labelCantidad.setAttribute('for', 'cantidadBulto' + i);
                labelCantidad.textContent = 'Cantidad para Bulto ' + i + ':';
                const inputCantidad = document.createElement('input');
                inputCantidad.type = 'number';
                inputCantidad.step = '0.01';
                inputCantidad.id = 'cantidadBulto' + i;
                // Nombre para el binding en el DTO (lista)
                inputCantidad.name = 'cantidadesBultos[' + (i - 1) + ']';
                inputCantidad.className = 'form-control';
                inputCantidad.required = true;
                // Si en el DTO ya hay una cantidad para este bulto, se asigna su valor
                if (cantidadesBultosDTO && cantidadesBultosDTO[i - 1] != null) {
                    inputCantidad.value = cantidadesBultosDTO[i - 1];
                }
                divCantidad.appendChild(labelCantidad);
                divCantidad.appendChild(inputCantidad);

                // --- Campo: Select de Subunidades para el bulto ---
                const divUnidad = document.createElement('div');
                divUnidad.className = 'col-md-3';
                const labelUnidad = document.createElement('label');
                labelUnidad.className = 'form-label';
                labelUnidad.textContent = 'Unidad:';
                const selectUnidad = document.createElement('select');
                selectUnidad.id = 'unidadSelect' + i;
                selectUnidad.name = 'unidadMedidaBultos[' + (i - 1) + ']';
                selectUnidad.className = 'form-select';
                selectUnidad.required = true;
                // Se determina si en el DTO existe un valor preseleccionado para este bulto
                let preselected = (unidadMedidaBultosDTO && unidadMedidaBultosDTO[i - 1]) ? unidadMedidaBultosDTO[i - 1] : null;
                // Se carga el select con las subunidades usando la unidad base y el valor preseleccionado
                cargarSubunidades(unidadBaseBultos, selectUnidad, preselected);

                divUnidad.appendChild(labelUnidad);
                divUnidad.appendChild(selectUnidad);

                // Se añade la fila con ambos campos al contenedor
                divRow.appendChild(divCantidad);
                divRow.appendChild(divUnidad);
                bultosContainer.appendChild(divRow);
            }
        }

        // =========================================================
        // Listener para cambios en el input de bultosTotales
        // =========================================================
        const bultosTotalesInput = document.getElementById('bultosTotales'); // Input de cantidad de bultos
        const distribucionDiv = document.getElementById('distribucionBultos'); // Contenedor de la distribución

        bultosTotalesInput.addEventListener('change', function () {
            const valor = parseInt(this.value);
            if (valor) {
                if (valor > 15 || valor < 1) {
                    this.value = 1; // Limitar a mínimo 1 bulto
                    distribucionDiv.classList.add('hidden');
                    bultosContainer.innerHTML = '';
                } else if (valor > 1) {
                    distribucionDiv.classList.remove('hidden');
                    generarCamposBultos(valor);
                } else {
                    distribucionDiv.classList.add('hidden');
                    bultosContainer.innerHTML = '';
                }
            }
        });

        // =========================================================
        // Listener para actualizar las subunidades de los bultos
        // Cuando la unidad de medida principal cambia, se actualizan todos los selects de bultos
        // =========================================================
        unidadSelect.addEventListener('change', function () {
            const nuevaUnidad = this.value;
            const selectsBultos = bultosContainer.querySelectorAll('select');
            selectsBultos.forEach(select => {
                cargarSubunidades(nuevaUnidad, select);
            });
        });

        function generarUnidadesBultos(unidadActual) {
            const selectsBultos = bultosContainer.querySelectorAll('select');
            selectsBultos.forEach(select => {
                cargarSubunidades(unidadActual, select);
            });
        }

        generarUnidadesBultos(unidadActual);
        // Si la página se recarga y el DTO trae un valor mayor a 1 en bultosTotales,
        // se muestra automáticamente el bloque de distribución y se generan los campos con los datos del DTO.


        var bultosValue;
        var bultosTotalesDTO = /*[[${loteDTO.bultosTotales}]]*/ [];
        if (bultosTotalesDTO && bultosTotalesDTO !== "null") {
            bultosValue = parseInt(bultosTotalesDTO);
        } else {
            bultosValue = parseInt(bultosTotalesInput.value);
        }
        if (bultosValue && bultosValue > 1) {
            distribucionDiv.classList.remove('hidden');
            generarCamposBultos(bultosValue);
        }
    });
</script>
</body>
</html>
