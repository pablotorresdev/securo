<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Ingreso de Stock y Distribución de Bultos</title>
    <!-- Bootstrap para estilos rápidos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Metadatos CSRF provistos por Spring Security/Thymeleaf -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
    <style>
        /* Utilidad para ocultar secciones via JS */
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">Ingreso de Stock por Produccion</h2>

    <!--
      Formulario principal:
      - POST a /produccion/alta/ingreso-produccion
      - th:object enlaza inputs con loteDTO (binding servidor <-> vista)
    -->
    <form method="post" th:action="@{/produccion/alta/ingreso-produccion}" th:object="${loteDTO}">
        <!-- Token CSRF en el body para validar la solicitud -->
        <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>

        <hr class="my-4">
        <h4 class="mb-3 text-primary">Datos Obligatorios</h4>

        <!-- Fecha de ingreso (default: hoy) -->
        <div class="mb-2">
            <label class="form-label" for="fechaIngreso">Fecha de Ingreso:</label>
            <input class="form-control" id="fechaIngreso" required th:field="*{fechaIngreso}" type="date">
            <div class="text-danger" th:errors="*{fechaIngreso}" th:if="${#fields.hasErrors('fechaIngreso')}"></div>
        </div>

        <!--
          Producto:
          - th:field bindea *{productoId}
          - Cada option expone:
            * data-unit: unidad base del producto (para cargar unidades compatibles)
            * data-tipo-producto: tipo (p.ej. UNIDAD_VENTA) para mostrar/ocultar campo de traza
        -->
        <div class="mb-2">
            <label class="form-label" for="productoId">Producto:</label>
            <select class="form-select" id="productoId" required th:field="*{productoId}">
                <option value="">-- Seleccione un producto --</option>
                <option
                        th:each="producto : ${productos}"
                        th:value="${producto.id}"
                        th:text="'Producto: ' + ${producto.nombreGenerico}
                         + ' | Tipo: ' + ${producto.tipoProducto.getValor()}
                         + ' | Grupo: ' + ${producto.tipoProducto.getGrupo()}
                         + ' | Codigo Producto: ' + ${producto.codigoProducto}
                         + (${producto.productoDestino} != null ? ' | Producto destino: ' + ${producto.productoDestino} : '')"
                        th:attr="data-unit=${producto.unidadMedida},data-tipo-producto=${producto.tipoProducto}">
                </option>
            </select>
            <div class="text-danger" th:errors="*{productoId}" th:if="${#fields.hasErrors('productoId')}"></div>
        </div>

        <!--
          Cantidad total + Unidad principal + Cantidad de bultos:
          - La unidad principal se llena con /enums/unidades-compatibles en base a la unidad del producto
          - bultosTotales gobierna la sección de distribución
        -->
        <div class="row mb-3 align-items-end">
            <div class="col-md-6">
                <label class="form-label" for="cantidadInicial">Cantidad:</label>
                <input class="form-control" id="cantidadInicial" required step="0.0001" th:field="*{cantidadInicial}" type="number">
                <div class="text-danger" th:errors="*{cantidadInicial}" th:if="${#fields.hasErrors('cantidadInicial')}"></div>
            </div>
            <div class="col-md-3">
                <label class="form-label" for="unidadMedida">Unidad de Medida:</label>
                <select class="form-select" id="unidadMedida" required th:field="*{unidadMedida}">
                    <option value="">-- Seleccione unidad --</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label" for="bultosTotales">Cantidad de Bultos Totales (1 a 15):</label>
                <input class="form-control" id="bultosTotales" max="15" min="1" required th:field="*{bultosTotales}" type="number">
                <div class="text-danger" th:errors="*{bultosTotales}" th:if="${#fields.hasErrors('bultosTotales')}"></div>
            </div>
        </div>

        <!-- Lote del proveedor (texto libre) -->
        <div class="mb-2">
            <label class="form-label" for="loteProveedor">Lote Proveedor:</label>
            <input class="form-control" id="loteProveedor" required th:field="*{loteProveedor}" type="text">
        </div>

        <!-- =========================================================
             Distribución de Bultos
             - Solo se muestra si bultosTotales > 1
             - Debe sumar exactamente "cantidadInicial" (validación de negocio lato sensu)
        ========================================================== -->
        <div class="hidden" id="distribucionBultos">
            <hr class="my-4">
            <h4 class="mb-3 text-primary">Distribución de Cantidades para los Bultos</h4>
            <p>La suma de las cantidades de cada bulto debe ser igual a la cantidad total ingresada.</p>
            <div id="bultosContainer"></div>
            <div class="text-danger" th:errors="*{cantidadesBultos}" th:if="${#fields.hasErrors('cantidadesBultos')}"></div>
        </div>

        <!-- Orden de producción: requerido para trazar el ingreso -->
        <div class="mb-3">
            <label class="form-label" for="ordenProduccion">Orden de Producción:</label>
            <input class="form-control" id="ordenProduccion" required th:field="*{ordenProduccion}" type="text">
            <div class="text-danger fw-bold" th:errors="*{ordenProduccion}" th:if="${#fields.hasErrors('ordenProduccion')}">
            </div>
        </div>

        <!-- =========================================================
             Datos Opcionales
        ========================================================== -->
        <hr class="my-4">
        <h4 class="mb-3 text-primary">Datos Opcionales</h4>

        <!--
          Traza inicial (solo para productos UNIDAD_VENTA):
          - Visible si data-tipo-producto === 'UNIDAD_VENTA'
          - Se pide para inicializar el rango de trazas generadas
        -->
        <div class="mb-2 hidden" id="trazaContainer">
            <label class="form-label" for="trazaInicial">Nro traza inicial:</label>
            <input class="form-control" id="trazaInicial" th:field="*{trazaInicial}" type="number">
            <div class="text-danger fw-bold" th:errors="*{trazaInicial}" th:if="${#fields.hasErrors('trazaInicial')}"></div>
        </div>

        <!-- Detalle de conservación a almacenar en el lote -->
        <div class="mb-2">
            <label class="form-label" for="detalleConservacion">Detalle de Conservación:</label>
            <textarea class="form-control" id="detalleConservacion" th:field="*{detalleConservacion}"></textarea>
        </div>

        <!-- Observaciones libres -->
        <div class="mb-2">
            <label class="form-label" for="observaciones">Observaciones:</label>
            <textarea class="form-control" id="observaciones" th:field="*{observaciones}"></textarea>
        </div>

        <!-- Acciones -->
        <div class="d-flex justify-content-between mt-3">
            <a class="btn btn-secondary" th:href="@{/produccion/alta/cancelar}">Cancelar</a>
            <button class="btn btn-primary" type="submit">Guardar</button>
        </div>
    </form>
</div>

<!-- Pie de página simple -->
<footer class="text-center p-3 mt-4" style="color: #aaa;">
    <p>&copy; 2025 Conitrack. All rights reserved.</p>
</footer>

<!-- =========================================================
     JS: carga de (sub)unidades y generación dinámica de campos de bultos
     - Repuebla valores desde el DTO si el servidor devolvió errores
     - Muestra campo de traza según tipo de producto
========================================================= -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {

        // Tokens CSRF para incluir en fetch()
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");
        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");

        // ---------- Inicialización de fecha ----------
        var fechaIngresoDTO = /*[[${loteDTO.fechaIngreso}]]*/ [];
        if (fechaIngresoDTO) {
            document.getElementById("fechaIngreso").value = fechaIngresoDTO;
        } else {
            const hoy = new Date();
            const hoyFormateado = hoy.toLocaleDateString("en-CA", { timeZone: "America/Argentina/Buenos_Aires" });
            document.getElementById("fechaIngreso").value = hoyFormateado;
        }

        // ---------- Unidades ----------
        // Select principal de unidad de medida (para la cantidad total)
        const unidadSelect = document.getElementById('unidadMedida');

        // Carga unidades compatibles (p.ej. para KG: {KG, G, MG, ...})
        function cargarUnidadesCompatibles(unidadBase) {
            if (!unidadBase) return;
            fetch('/enums/unidades-compatibles?unidad=' + unidadBase, {
                method: 'GET',
                headers: {[csrfHeader]: csrfToken}
            })
                .then(response => response.json())
                .then(data => {
                    unidadSelect.innerHTML = '<option value="">-- Seleccione unidad --</option>';
                    data.forEach(unidad => {
                        const option = document.createElement('option');
                        option.value = unidad;
                        option.textContent = unidad;
                        // Por defecto deja seleccionada la base
                        if (unidad === unidadBase) option.selected = true;
                        unidadSelect.appendChild(option);
                    });
                })
                .catch(error => console.error("Error al cargar unidades:", error));
        }

        // Unidad actual inyectada desde el DTO (o por defecto 'UNIDAD')
        const unidadActual = /*[[${loteDTO.unidadMedida}]]*/ 'UNIDAD';
        cargarUnidadesCompatibles(unidadActual);

        // ---------- Subunidades por bulto ----------
        const bultosContainer = document.getElementById('bultosContainer'); // contenedor para filas de bultos

        // Al cambiar el producto, recarga unidades compatibles y subunidades de cada bulto
        document.getElementById('productoId').addEventListener('change', function () {
            const unidadBase = this.options[this.selectedIndex].getAttribute('data-unit');
            cargarUnidadesCompatibles(unidadBase);
            // También actualizar los selects de cada bulto (si ya existen)
            const selectsBultos = bultosContainer.querySelectorAll('select');
            selectsBultos.forEach(select => {
                cargarSubunidades(unidadBase, select);
            });
        });

        // Carga subunidades (G, MG, etc.) para un select de bulto concreto
        function cargarSubunidades(unidadBase, selectElement, preselected) {
            if (!unidadBase) return;
            fetch('/enums/subunidades?unidad=' + unidadBase, {
                method: 'GET',
                headers: {[csrfHeader]: csrfToken}
            })
                .then(response => response.json())
                .then(data => {
                    selectElement.innerHTML = '<option value="">-- Seleccione unidad --</option>';
                    data.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u;
                        option.textContent = u;
                        // Mantener el valor previo si existe, sino seleccionar la base
                        if (preselected) {
                            if (u === preselected) option.selected = true;
                        } else {
                            if (u === unidadBase) option.selected = true;
                        }
                        selectElement.appendChild(option);
                    });
                })
                .catch(error => console.error("Error al cargar subunidades:", error));
        }

        // Valores de DTO para restauración de la distribución
        var unidadMedidaBultosDTO = /*[[${loteDTO.unidadMedidaBultos != null ? loteDTO.unidadMedidaBultos : '[]'}]]*/ [];
        var cantidadesBultosDTO = /*[[${loteDTO.cantidadesBultos != null ? loteDTO.cantidadesBultos : '[]'}]]*/ [];

        // Genera N filas de "Bulto i" con (cantidad + subunidad)
        function generarCamposBultos(cantidad) {
            bultosContainer.innerHTML = ''; // limpiar
            // Usar la unidad del select principal (o la actual) como base de subunidades
            const unidadBaseBultos = unidadSelect.value || unidadActual;

            for (let i = 1; i <= cantidad; i++) {
                // --- Creación de la fila para el bulto ---
                const divRow = document.createElement('div');
                divRow.className = 'row mb-3 align-items-end';

                // --- Cantidad del bulto i ---
                const divCantidad = document.createElement('div');
                divCantidad.className = 'col-md-6';
                const labelCantidad = document.createElement('label');
                labelCantidad.className = 'form-label';
                labelCantidad.setAttribute('for', 'cantidadBulto' + i);
                labelCantidad.textContent = 'Cantidad para Bulto ' + i + ':';
                const inputCantidad = document.createElement('input');
                inputCantidad.type = 'number';
                inputCantidad.step = '0.01';
                inputCantidad.id = 'cantidadBulto' + i;
                // Nombre de lista para binding: cantidadesBultos[i-1]
                inputCantidad.name = 'cantidadesBultos[' + (i - 1) + ']';
                inputCantidad.className = 'form-control';
                inputCantidad.required = true;
                // Restaurar si el DTO trae valor
                if (cantidadesBultosDTO && cantidadesBultosDTO[i - 1] != null) {
                    inputCantidad.value = cantidadesBultosDTO[i - 1];
                }
                divCantidad.appendChild(labelCantidad);
                divCantidad.appendChild(inputCantidad);

                // --- Subunidad del bulto i ---
                const divUnidad = document.createElement('div');
                divUnidad.className = 'col-md-3';
                const labelUnidad = document.createElement('label');
                labelUnidad.className = 'form-label';
                labelUnidad.textContent = 'Unidad:';
                const selectUnidad = document.createElement('select');
                selectUnidad.id = 'unidadSelect' + i;
                // Nombre de lista para binding: unidadMedidaBultos[i-1]
                selectUnidad.name = 'unidadMedidaBultos[' + (i - 1) + ']';
                selectUnidad.className = 'form-select';
                selectUnidad.required = true;

                // Preselección si viene desde DTO
                let preselected = (unidadMedidaBultosDTO && unidadMedidaBultosDTO[i - 1]) ? unidadMedidaBultosDTO[i - 1] : null;
                // Poblar opciones
                cargarSubunidades(unidadBaseBultos, selectUnidad, preselected);

                divUnidad.appendChild(labelUnidad);
                divUnidad.appendChild(selectUnidad);

                // Agregar fila al contenedor
                divRow.appendChild(divCantidad);
                divRow.appendChild(divUnidad);
                bultosContainer.appendChild(divRow);
            }
        }

        // ---------- Comportamiento de "bultosTotales" ----------
        const bultosTotalesInput = document.getElementById('bultosTotales'); // Input de cantidad de bultos
        const distribucionDiv = document.getElementById('distribucionBultos'); // Contenedor de la distribución

        // Mostrar/ocultar bloque de distribución y generar filas
        bultosTotalesInput.addEventListener('change', function () {
            const valor = parseInt(this.value);
            if (valor) {
                if (valor > 15 || valor < 1) {
                    // Defensa extra (igual hay min/max en el input)
                    this.value = 1; // Limitar a mínimo 1 bulto
                    distribucionDiv.classList.add('hidden');
                    bultosContainer.innerHTML = '';
                } else if (valor > 1) {
                    distribucionDiv.classList.remove('hidden');
                    generarCamposBultos(valor);
                } else {
                    distribucionDiv.classList.add('hidden');
                    bultosContainer.innerHTML = '';
                }
            }
        });

        // Si cambia la unidad principal, refrescar subunidades de todos los bultos
        unidadSelect.addEventListener('change', function () {
            const nuevaUnidad = this.value;
            const selectsBultos = bultosContainer.querySelectorAll('select');
            selectsBultos.forEach(select => {
                cargarSubunidades(nuevaUnidad, select);
            });
        });

        // Helper para regenerar subunidades en todos los bultos (al inicio)
        function generarUnidadesBultos(unidadActual) {
            const selectsBultos = bultosContainer.querySelectorAll('select');
            selectsBultos.forEach(select => {
                cargarSubunidades(unidadActual, select);
            });
        }

        // Llama al helper (no hará nada si aún no hay selects de bultos)
        generarUnidadesBultos(unidadActual);

        // ---------- Restauración automática de la distribución ----------
        // Si el DTO trae bultosTotales > 1, mostrar bloque y recrear filas con datos previos
        var bultosValue;
        var bultosTotalesDTO = /*[[${loteDTO.bultosTotales}]]*/ [];
        if (bultosTotalesDTO && bultosTotalesDTO !== "null") {
            bultosValue = parseInt(bultosTotalesDTO);
        } else {
            bultosValue = parseInt(bultosTotalesInput.value);
        }
        if (bultosValue && bultosValue > 1) {
            distribucionDiv.classList.remove('hidden');
            generarCamposBultos(bultosValue);
        }

        // ---------- Mostrar/ocultar campo de Traza según tipo de producto ----------
        function toggleTrazaInput() {
            const selectProd = document.getElementById('productoId');
            const opt        = selectProd.options[selectProd.selectedIndex];
            const tipo       = opt.getAttribute('data-tipo-producto'); // p.ej. 'UNIDAD_VENTA'
            const cont       = document.getElementById('trazaContainer');
            const inp        = document.getElementById('trazaInicial');

            if (tipo === 'UNIDAD_VENTA') {
                cont.classList.remove('hidden');
                inp.required = true;
            } else {
                cont.classList.add('hidden');
                inp.required = false;
                inp.value = '';
            }
        }

        // Al cargar, intenta setear visibilidad correctamente
        toggleTrazaInput();
        // Al cambiar el producto, volver a evaluar
        document.getElementById('productoId').addEventListener('change', toggleTrazaInput);

    });
</script>
</body>
</html>
