<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Consumo por Producción</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>

<div class="container mt-5">
    <h2 class="mb-4">Consumo por Producción</h2>
    <form th:action="@{/produccion/consumo-produccion}" th:object="${loteDTO}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <!-- SELECCIÓN DEL LOTE -->
        <div class="mb-3">
            <label for="loteSelect" class="form-label">Seleccione el Lote a Consumir:</label>
            <select id="loteSelect" class="form-select">
                <option value="">-- Seleccione un Lote --</option>
                <option th:each="loteDTO : ${lotesProduccion}"
                        th:value="${loteDTO.codigoInterno}"
                        th:text="'Nombre: ' + ${loteDTO.nombreProducto} +
                  ' | Nro Analisis: ' + ${loteDTO.getCurrentNroAnalisis()} +
                  ' | Codigo Interno: ' + ${loteDTO.codigoInterno}">
                </option>
            </select>
        </div>

        <div id="infoLote" class="border p-3 bg-light mb-4" style="display:none;">
            <h5>Detalles del Lote</h5>
            <div id="infoContent"></div>
        </div>

        <div class="mb-3">
            <label for="fechaEgreso" class="form-label">Fecha de Consumo por Producción:</label>
            <input type="date" id="fechaEgreso" th:field="*{fechaEgreso}" class="form-control" required>
            <div th:if="${#fields.hasErrors('fechaEgreso')}" class="text-danger fw-bold" th:errors="*{fechaEgreso}">
            </div>
        </div>

        <div class="mb-3">
            <label for="ordenProduccion" class="form-label">Orden de Producción:</label>
            <input type="text" id="ordenProduccion" th:field="*{ordenProduccion}" class="form-control" required>
            <div th:if="${#fields.hasErrors('ordenProduccion')}" class="text-danger fw-bold" th:errors="*{ordenProduccion}">
            </div>
        </div>

        <!-- OBSERVACIONES -->
        <div class="mb-3">
            <label for="observaciones" class="form-label">Observaciones:</label>
            <textarea id="observaciones"
                      th:field="*{observaciones}"
                      class="form-control"
                      rows="3"></textarea>
        </div>

        <!-- BOTONES -->
        <div class="d-flex justify-content-between mt-3">
            <a th:href="@{/produccion/cancelar}" class="btn btn-secondary">Cancelar</a>
            <button type="submit" class="btn btn-primary">Guardar</button>
        </div>
    </form>
</div>

<footer class="text-center p-3 mt-4" style="color: #aaa;">
    <p>&copy; 2025 Conitrack. All rights reserved.</p>
</footer>

<!-- ========================================================= -->
<!-- JS: Manejo de datos de lotes (SIN fetch) y generación bultos -->
<!-- ========================================================= -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {

        const csrfHeader = document.querySelector('meta[name="_csrf_header"]').getAttribute("content");
        const csrfToken = document.querySelector('meta[name="_csrf"]').getAttribute("content");

        // 1) Embebemos lotesProduccion como JSON
        //    De este modo, no necesitamos fetch.
        var lotesDtoData = /*[[${lotesProduccion}]]*/ '[]';
        // Esto produce un array de objetos Lote (con la info que tu Entity expone),
        //  y podremos buscar en él según el ID seleccionado.

        // Conviértelo a array real
        if (typeof lotesDtoData === 'string') {
            lotesDtoData = JSON.parse(lotesDtoData);
        }


        const loteSelect = document.getElementById('loteSelect');
        const infoLoteDiv = document.getElementById('infoLote');
        const infoContent = document.getElementById('infoContent');

        // Evento al cambiar el combo de Lote
        loteSelect.addEventListener('change', function () {
            const codigoInterno = this.value;
            console.log('Codigo interno selected:'  +codigoInterno);
            if (!codigoInterno) {
                infoLoteDiv.style.display = 'none';
                infoContent.innerHTML = '';
                return;
            }

            // Buscamos el Lote en lotesData
            const loteDto = lotesDtoData.find(l => l.codigoInterno === codigoInterno);
            if (loteDto) {
                mostrarLoteInfo(loteDto);
            }
        });

        function mostrarLoteInfo(loteDto) {
            console.log(loteDto);

            let html = '';
            html += '<p><strong>Código Interno:</strong> ' + (loteDto.codigoInterno || 'N/D') + '</p>';
            html += '<p><strong>Producto:</strong> ' + (loteDto.nombreProducto || 'N/D') + '</p>';
            html += '<p><strong>Producto destino:</strong> ' + (loteDto.productoDestino || 'N/D') + '</p>';
            html += '<p><strong>Cantidad Inicial:</strong> ' + (loteDto.cantidadInicial || 'N/D') + '</p>';
            html += '<p><strong>Nro Bultos Iniciales:</strong> ' + (loteDto.bultosTotales || 'N/D') + '</p>';
            html += '<p><strong>Cantidad Actual:</strong> ' + (loteDto.cantidadActual || 'N/D') + '</p>';
            html += '<p><strong>Nro Bultos Actuales:</strong> ' + (loteDto.bultosActuales || 'N/D') + '</p>';
            html += '<p><strong>Unidad Medida:</strong> ' + (loteDto.unidadMedida || 'N/D') + '</p>';
            html += '<p><strong>Nro Análisis:</strong> ' + (loteDto.currentNroAnalisis || 'Sin fecha') + '</p>';
            html += '<p><strong>Fecha ultimo Análisis:</strong> ' + (loteDto.currentAnalisisDto.fechaRealizado || 'Sin fecha') + '</p>';
            html += '<p><strong>Fecha Re-Análisis:</strong> ' + (loteDto.currentAnalisisDto.fechaReanalisis || 'Sin fecha') + '</p>';
            html += '<p><strong>Fecha vencimiento:</strong> ' + (loteDto.currentAnalisisDto.fechaVencimiento || 'Sin fecha') + '</p>';
            html += '<p><strong>Fecha Reanálisis Proveedor:</strong> ' + (loteDto.fechaReanalisisProveedor || 'N/D') + '</p>';
            html += '<p><strong>Fecha Vencimiento Proveedor:</strong> ' + (loteDto.fechaVencimientoProveedor || 'N/D') + '</p>';

            infoContent.innerHTML = html;
            infoLoteDiv.style.display = 'block';
        }


    });
</script>
</body>
</html>
