<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Devolución de cliente con desvio QA</title>
    <!-- Bootstrap para estilos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Metadatos CSRF para formularios y fetch -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">Devolución de cliente con desvio QA [Gerente garantía de calidad] </h2>

    <!--
      Formulario principal:
      - POST a /ventas/alta/devolucion-venta
      - th:object vincula los campos con movimientoDTO (binding servidor <-> vista)
    -->
    <form method="post" th:action="@{/ventas/alta/devolucion-venta}" th:object="${movimientoDTO}">
        <!-- Token CSRF (campo oculto) -->
        <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>

        <!--
          Contenedor donde se crearán inputs ocultos para movimientoDTO.trazaDTOs[i]
          durante el submit (desde JS), a partir de los checkboxes tildados.
        -->
        <div id="trazasHidden"></div>

        <hr class="my-4">
        <h5 class="mb-3 text-primary">Datos Obligatorios</h5>

        <!--
          Select de Lotes:
          - th:field="*{codigoLote}" bindea el valor al DTO
          - Cada option muestra datos del lote: producto, código, fechas, rango de trazas
        -->
        <div class="mb-3">
            <label class="form-label" for="codigoLote">Lote:</label>
            <select class="form-select" id="codigoLote" required th:field="*{codigoLote}">
                <option value="">-- Seleccione un Lote --</option>
                <option th:each="loteDTO : ${lotesDevolucion}"
                        th:text="'Producto: ' + ${loteDTO.nombreProducto}
                         + ' | Codigo interno: ' + ${loteDTO.codigoLote}
                         + ' | Fecha ingreso: ' + ${loteDTO.fechaIngreso}
                         + ' | Rango Trazas: ' + ${loteDTO.trazaInicial}
                         + '/' + ${loteDTO.trazaFinal}"
                        th:value="${loteDTO.codigoLote}">
                </option>
            </select>
        </div>

        <!--
          Select de Movimientos de venta asociados al lote:
          - Se carga dinámicamente via fetch cuando cambia el lote
          - Se bindea a *{codigoMovimientoOrigen}
          - Se muestra/oculta según disponibilidad y errores del servidor
        -->
        <div class="mb-3" id="wrapperMovVentas"
             th:style="${#fields.hasErrors('codigoMovimientoOrigen')}? '' : 'display:none;'">
            <label class="form-label" for="movVentaId">Movimiento de Venta:</label>
            <select class="form-select" id="movVentaId"
                    th:field="*{codigoMovimientoOrigen}" required>
                <option value="">-- Seleccione un movimiento --</option>
            </select>
            <!-- Mensaje de error server-side para el movimiento origen -->
            <div class="text-danger fw-bold mt-2"
                 th:errors="*{codigoMovimientoOrigen}"
                 th:if="${#fields.hasErrors('codigoMovimientoOrigen')}">
            </div>
        </div>

        <!--
          Bloque de Trazas:
          - Se llena via fetch al seleccionar un movimiento
          - Permite seleccionar (checkbox) qué unidades/trazas serán devueltas
          - Incluye “seleccionar todas” global y por bulto
          - Errores client-side (sin submit) y server-side (BindingResult)
        -->
        <div class="mb-3" id="wrapperTrazas"
             th:style="${#fields.hasErrors('trazaDTOs')}? '' : 'display:none;'">
            <label class="form-label">Trazas vendidas del movimiento (seleccione las unidades devueltas):</label>
            <div id="trazasContainer" class="border rounded p-3"></div>

            <!-- Error client-side si no se selecciona al menos una traza -->
            <div id="trazasError" class="text-danger fw-bold mt-2" style="display:none;">
                Seleccioná al menos una traza.
            </div>
            <!-- Error server-side de binding -->
            <div class="text-danger fw-bold mt-2"
                 th:errors="*{trazaDTOs}"
                 th:if="${#fields.hasErrors('trazaDTOs')}">
            </div>
        </div>

        <!--
          Fecha de la devolución (obligatoria):
          - type="date" bindeado a *{fechaMovimiento}
          - JS inicializa a “hoy” (TZ Buenos Aires) si no viene desde el DTO
        -->
        <div class="mb-2">
            <label class="form-label" for="fechaMovimiento">Fecha Devolucion:</label>
            <input class="form-control" id="fechaMovimiento" name="fechaMovimiento"
                   required
                   th:classappend="${#fields.hasErrors('fechaMovimiento')} ? ' error-field' : ''"
                   th:field="*{fechaMovimiento}"
                   type="date">

            <div style="color: red; font-weight: bold;"
                 th:errors="*{fechaMovimiento}"
                 th:if="${#fields.hasErrors('fechaMovimiento')}"></div>
        </div>

        <!-- Observaciones libres (opcional) -->
        <div class="mb-3">
            <label class="form-label" for="observaciones">Observaciones (opcional):</label>
            <textarea class="form-control"
                      id="observaciones"
                      rows="2"
                      th:field="*{observaciones}"></textarea>
        </div>

        <!-- Acciones del formulario -->
        <div class="d-flex justify-content-between mt-4">
            <a class="btn btn-secondary" th:href="@{/ventas/alta/cancelar}">Cancelar</a>
            <button class="btn btn-primary" type="submit">Realizar devolución</button>
        </div>
    </form>
</div>

<!-- Pie de página simple -->
<footer class="text-center mt-4 text-muted">
    <p>&copy; 2025 Conitrack. All rights reserved.</p>
</footer>

<!-- =========================================================
     JS de la vista:
     - Carga movimientos del lote seleccionado
     - Carga trazas vendidas por movimiento (con select all global y por bulto)
     - Restaura selecciones si se vuelve con errores
     - En submit, construye movimientoDTO.trazaDTOs[*] en inputs ocultos
========================================================= -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', async function () {
        /* ---------- Referencias base y elementos ---------- */
        const base       = /*[[@{/}]]*/ '';
        const loteSelect = document.getElementById('codigoLote');
        const movWrapper = document.getElementById('wrapperMovVentas');
        const movSelect  = document.getElementById('movVentaId');

        const trazasWrapper   = document.getElementById('wrapperTrazas');
        const trazasContainer = document.getElementById('trazasContainer');
        const trazasError     = document.getElementById('trazasError');
        const trazasHidden    = document.getElementById('trazasHidden');

        /* ---------- Estado restaurable (si la página vuelve con errores) ---------- */
        const selectedCodLote = /*[[${movimientoDTO.codigoLote}]]*/ null;
        const selectedCodMov  = /*[[${movimientoDTO.codigoMovimientoOrigen}]]*/ null;
        // Estructura esperada: [{codigoLote, nroBulto, nroTraza}, ...]
        const selectedTrazas  = /*[[${movimientoDTO.trazaDTOs}]]*/ []; // [{codigoLote,nroBulto,nroTraza},...]

        /* ---------- Utilidades de UI (Trazas) ---------- */
        // Limpia contenedor de trazas y oculta bloque
        function clearTrazasUI() {
            trazasContainer.innerHTML = '';
            trazasWrapper.style.display = 'none';
            if (trazasError) trazasError.style.display = 'none';
            trazasHidden.innerHTML = '';
        }

        // Marca/desmarca el checkbox maestro del grupo (por bulto)
        function syncGroupMaster(groupEl) {
            const cbs = groupEl.querySelectorAll('input[type="checkbox"][name="nrosTrazasDevolver"]');
            const allChecked = cbs.length && Array.from(cbs).every(cb => cb.checked);
            const master = groupEl.querySelector('.checkAllBulto');
            if (master) master.checked = allChecked;
        }

        // Sincroniza el “Seleccionar todas” global según el estado de todas las trazas
        function syncGlobalMaster() {
            const all = trazasContainer.querySelectorAll('input[type="checkbox"][name="nrosTrazasDevolver"]');
            const anyExist = all.length > 0;
            const allChecked = anyExist && Array.from(all).every(cb => cb.checked);
            const masterGlobal = trazasContainer.querySelector('#checkAllTrazas');
            if (masterGlobal) masterGlobal.checked = anyExist && allChecked;
        }

        /* ---------- Carga dinámica de datos ---------- */
        // Carga movimientos del lote (opción de preseleccionar + callback al terminar)
        async function loadMovimientos(codInterno, preselectCodigoMov, afterLoaded) {
            movSelect.innerHTML = '<option value="">-- Seleccione un movimiento --</option>';
            movWrapper.style.display = 'none';
            movSelect.required = false;

            if (!codInterno) return;

            const url = base + 'movimientos/movimientos-venta/' + encodeURIComponent(codInterno);
            try {
                const resp = await fetch(url, { method: 'GET' });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();

                // Popular opciones
                data.forEach(mov => {
                    const opt = document.createElement('option');
                    const fecha = mov.fechaMovimiento ?? mov.fecha ?? '';
                    const cant  = mov.cantidad ?? '';
                    const um    = mov.unidadMedida ?? '';
                    opt.value   = mov.codigoMovimiento; // clave que viaja al back
                    opt.text    = `Fecha: ${fecha} | Cant: ${cant} ${um}`;
                    movSelect.appendChild(opt);
                });

                // Mostrar u ocultar el wrapper según si hay movimientos
                movWrapper.style.display = data.length ? 'block' : 'none';
                movSelect.required = data.length > 0;

                // Preseleccionar si corresponde (restauración)
                if (preselectCodigoMov) {
                    movSelect.value = preselectCodigoMov;
                }

                if (typeof afterLoaded === 'function') afterLoaded();

            } catch (e) {
                console.error('Error movimientos:', e);
                alert('No se pudieron cargar los movimientos de venta para ese lote.');
            }
        }

        // Carga trazas del movimiento (y restaura checks previamente seleccionados)
        async function loadTrazas(codInternoMov, preselectedTrazas) {
            clearTrazasUI();
            if (!codInternoMov) return;

            const url = base + 'trazas/trazas-vendidas/movimiento/' + encodeURIComponent(codInternoMov);
            try {
                const resp = await fetch(url, { method: 'GET' });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                const data = await resp.json();

                if (data.length === 0) {
                    trazasWrapper.style.display = 'none';
                    return;
                }

                // Agrupar trazas por nroBulto
                const porBulto = new Map();
                data.forEach(t => {
                    const key = t.nroBulto;
                    if (!porBulto.has(key)) porBulto.set(key, []);
                    porBulto.get(key).push(t);
                });

                /* ----- Barra “Seleccionar todas las trazas” (global) ----- */
                const masterBar = document.createElement('div');
                masterBar.className = 'd-flex align-items-center gap-3 mb-3';
                masterBar.innerHTML = `
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="checkAllTrazas">
                    <label class="form-check-label fw-bold" for="checkAllTrazas">Seleccionar todas las trazas</label>
                  </div>
                `;
                trazasContainer.appendChild(masterBar);

                // Listener global para marcar/desmarcar todas
                const checkAllTrazas = masterBar.querySelector('#checkAllTrazas');
                checkAllTrazas.addEventListener('change', (e) => {
                    const checked = e.target.checked;
                    trazasContainer.querySelectorAll('input[type="checkbox"][name="nrosTrazasDevolver"]').forEach(cb => {
                        cb.checked = checked;
                    });
                    trazasContainer.querySelectorAll('.checkAllBulto').forEach(g => g.checked = checked);
                });

                /* ----- Render de grupos por bulto con su maestro propio ----- */
                porBulto.forEach((trazas, nroBulto) => {
                    const group = document.createElement('div');
                    group.className = 'mb-3 border rounded p-2';
                    group.dataset.bulto = String(nroBulto);

                    // Cabecera del grupo (título + “todas las trazas del bulto”)
                    const header = document.createElement('div');
                    header.className = 'd-flex align-items-center justify-content-between mb-2';
                    const masterId = `checkAllBulto_${nroBulto}`;
                    header.innerHTML = `
                        <div class="fw-bold">Bulto Nro ${nroBulto}:</div>
                        <div class="form-check">
                          <input class="form-check-input checkAllBulto" type="checkbox" id="${masterId}">
                          <label class="form-check-label" for="${masterId}">Todas las trazas del bulto</label>
                        </div>
                    `;

                    // Contenedor de checkboxes individuales
                    const items = document.createElement('div');
                    items.className = 'd-flex flex-wrap gap-3';

                    // Crear checkbox por cada traza vendida
                    trazas.forEach((t) => {
                        const id = `traza_${nroBulto}_${t.nroTraza}`;
                        const wrapper = document.createElement('div');
                        wrapper.className = 'form-check';

                        const cb = document.createElement('input');
                        cb.type = 'checkbox';
                        cb.className = 'form-check-input';
                        cb.id = id;
                        cb.name  = 'nrosTrazasDevolver';   // todos comparten el mismo name (grupo)
                        cb.value = t.nroTraza;
                        cb.dataset.bulto = String(nroBulto);

                        const lb = document.createElement('label');
                        lb.className = 'form-check-label';
                        lb.setAttribute('for', id);
                        lb.textContent = `[${t.nroTraza}]`;

                        wrapper.appendChild(cb);
                        wrapper.appendChild(lb);
                        items.appendChild(wrapper);
                    });

                    // Maestro del grupo: marca/desmarca todas las trazas del bulto
                    header.querySelector('.checkAllBulto').addEventListener('change', (e) => {
                        const checked = e.target.checked;
                        group.querySelectorAll('input[type="checkbox"][name="nrosTrazasDevolver"]').forEach(cb => {
                            cb.checked = checked;
                        });
                        syncGlobalMaster();
                    });

                    // Cuando cambian checks individuales, sincroniza maestros
                    items.addEventListener('change', (e) => {
                        if (e.target && e.target.matches('input[type="checkbox"][name="nrosTrazasDevolver"]')) {
                            syncGroupMaster(group);
                            syncGlobalMaster();
                        }
                    });

                    group.appendChild(header);
                    group.appendChild(items);
                    trazasContainer.appendChild(group);
                });

                // Restaurar selección previa (si existía)
                if (Array.isArray(preselectedTrazas) && preselectedTrazas.length > 0) {
                    preselectedTrazas.forEach(t => {
                        const selector = `input[type="checkbox"][name="nrosTrazasDevolver"][value="${t.nroTraza}"][data-bulto="${t.nroBulto}"]`;
                        const cb = trazasContainer.querySelector(selector);
                        if (cb) cb.checked = true;
                    });
                    // Actualizar maestros
                    trazasContainer.querySelectorAll('[data-bulto]').forEach(group => syncGroupMaster(group));
                    syncGlobalMaster();
                }

                trazasWrapper.style.display = 'block';

            } catch (e) {
                console.error('Error trazas:', e);
                alert('No se pudieron cargar las trazas vendidas de ese movimiento.');
            }
        }

        /* ---------- Eventos principales ---------- */

        // Al cambiar el lote: carga los movimientos y limpia trazas
        loteSelect.addEventListener('change', async () => {
            await loadMovimientos(loteSelect.value, null, () => {});
            clearTrazasUI();
        });

        // Al cambiar el movimiento: carga las trazas vendidas
        movSelect.addEventListener('change', async () => {
            await loadTrazas((movSelect.value || '').trim(), []);
        });

        // Enviar formulario:
        // - Valida que haya al menos una traza si el bloque está visible
        // - Construye inputs ocultos trazaDTOs[i].{codigoLote,nroBulto,nroTraza}
        const form = document.querySelector('form');
        form.addEventListener('submit', (ev) => {
            const checks = trazasContainer.querySelectorAll('input[type="checkbox"][name="nrosTrazasDevolver"]:checked');

            // Validación client-side simple
            if (trazasWrapper.style.display !== 'none' && checks.length === 0) {
                ev.preventDefault();
                if (trazasError) {
                    trazasError.style.display = 'block';
                    trazasError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            } else if (trazasError) {
                trazasError.style.display = 'none';
            }

            // Regenerar hidden inputs con las trazas seleccionadas
            trazasHidden.innerHTML = '';
            const codigoLoteSel = (loteSelect.value || '').trim();
            let idx = 0;
            checks.forEach(cb => {
                const nroTraza = cb.value;
                const nroBulto = cb.dataset.bulto;

                const h1 = document.createElement('input');
                h1.type = 'hidden';
                h1.name = `trazaDTOs[${idx}].codigoLote`;
                h1.value = codigoLoteSel;
                trazasHidden.appendChild(h1);

                const h2 = document.createElement('input');
                h2.type = 'hidden';
                h2.name = `trazaDTOs[${idx}].nroBulto`;
                h2.value = nroBulto;
                trazasHidden.appendChild(h2);

                const h3 = document.createElement('input');
                h3.type = 'hidden';
                h3.name = `trazaDTOs[${idx}].nroTraza`;
                h3.value = nroTraza;
                trazasHidden.appendChild(h3);

                idx++;
            });
        });

        // Inicializa fecha por defecto (hoy) si no vino en el DTO
        const fechaMovimientoDTO = /*[[${movimientoDTO.fechaMovimiento}]]*/ null;
        const fechaInput = document.getElementById("fechaMovimiento");
        fechaInput.value = fechaMovimientoDTO ||  new Date().toLocaleDateString("en-CA", { timeZone: "America/Argentina/Buenos_Aires" });

        // Restauración automática:
        // Si ya había lote/movimiento/trazas seleccionados, recarga y preselecciona todo
        if (selectedCodLote) {
            // Carga movimientos y luego preselecciona, y luego carga trazas y prechequea
            await loadMovimientos(selectedCodLote, selectedCodMov, async () => {
                if (selectedCodMov) {
                    await loadTrazas(selectedCodMov, selectedTrazas || []);
                }
            });
        }

        // Enfocar el primer campo con error (si existe)
        const errorField = document.querySelector('.error-field');
        if (errorField) errorField.focus();
    });
</script>
</body>
</html>
