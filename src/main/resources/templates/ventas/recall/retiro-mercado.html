<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Retiro mercado</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">Retiro mercado</h2>
    <form method="post" th:action="@{/ventas/recall/retiro-mercado}" th:object="${movimientoDTO}">
        <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>

        <!-- Inputs ocultos para movimientoDTO.trazaDTOs -->
        <div id="trazasHidden"></div>

        <hr class="my-4">
        <h5 class="mb-3 text-primary">Datos Obligatorios</h5>

        <!-- Lote -->
        <div class="mb-3">
            <label class="form-label" for="codigoLote">Lote:</label>
            <select class="form-select" id="codigoLote" required th:field="*{codigoLote}">
                <option value="">-- Seleccione un Lote --</option>
                <option th:each="loteDTO : ${lotesRecall}"
                        th:text="'Producto: ' + ${loteDTO.nombreProducto}
                         + ' | Codigo interno: ' + ${loteDTO.codigoLote}
                         + ' | Fecha ingreso: ' + ${loteDTO.fechaIngreso}
                         + ' | Rango Trazas: ' + ${loteDTO.trazaInicial}
                         + '/' + ${loteDTO.trazaFinal}"
                        th:value="${loteDTO.codigoLote}">
                </option>
            </select>
        </div>

        <!-- Trazas (todas juntas, sin agrupar por bulto) -->
        <div class="mb-3" id="wrapperTrazas" th:style="${#fields.hasErrors('trazaDTOs')}? '' : 'display:none;'">
            <label class="form-label">Trazas vendidas del lote (seleccione las unidades a retirar):</label>

            <!-- Maestro seleccionar todas -->
            <div class="form-check mb-2" id="masterBar" style="display:none;">
                <input class="form-check-input" type="checkbox" id="checkAllTrazas">
                <label class="form-check-label fw-bold" for="checkAllTrazas">Seleccionar todas las trazas</label>
            </div>

            <div id="trazasContainer" class="border rounded p-3"></div>

            <!-- Error client-side -->
            <div id="trazasError" class="text-danger fw-bold mt-2" style="display:none;">
                Seleccioná al menos una traza.
            </div>
            <!-- Error server-side -->
            <div class="text-danger fw-bold mt-2"
                 th:errors="*{trazaDTOs}"
                 th:if="${#fields.hasErrors('trazaDTOs')}">
            </div>
        </div>

        <!-- Fecha -->
        <div class="mb-2">
            <label class="form-label" for="fechaMovimiento">Fecha del Recall:</label>
            <input class="form-control" id="fechaMovimiento" name="fechaMovimiento"
                   required
                   th:classappend="${#fields.hasErrors('fechaMovimiento')} ? ' error-field' : ''"
                   th:field="*{fechaMovimiento}"
                   type="date">

            <div style="color: red; font-weight: bold;"
                 th:errors="*{fechaMovimiento}"
                 th:if="${#fields.hasErrors('fechaMovimiento')}"></div>
        </div>

        <!-- Observaciones -->
        <div class="mb-3">
            <label class="form-label" for="observaciones">Observaciones (opcional):</label>
            <textarea class="form-control"
                      id="observaciones"
                      rows="2"
                      th:field="*{observaciones}"></textarea>
        </div>

        <!-- Botones -->
        <div class="d-flex justify-content-between mt-4">
            <a class="btn btn-secondary" th:href="@{/ventas/recall/cancelar}">Cancelar</a>
            <button class="btn btn-primary" type="submit">Realizar retiro mercado</button>
        </div>
    </form>
</div>

<footer class="text-center mt-4 text-muted">
    <p>&copy; 2025 Conitrack. All rights reserved.</p>
</footer>

<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const base            = /*[[@{/}]]*/ '';
        const loteSelect      = document.getElementById('codigoLote');
        const trazasWrapper   = document.getElementById('wrapperTrazas');
        const trazasContainer = document.getElementById('trazasContainer');
        const masterBar       = document.getElementById('masterBar');
        const masterAll       = document.getElementById('checkAllTrazas');
        const trazasError     = document.getElementById('trazasError');
        const trazasHidden    = document.getElementById('trazasHidden');

        // Estado DTO para restaurar selección tras validaciones
        const selectedCodLote = /*[[${movimientoDTO.codigoLote}]]*/ null;
        const selectedTrazas  = /*[[${movimientoDTO.trazaDTOs}]]*/ []; // [{nroTraza, nroBulto, codigoLote}...]

        // Fecha por defecto (como tus otras pantallas)
        const fechaDTO  = /*[[${movimientoDTO.fechaMovimiento}]]*/ null;
        const fechaInput = document.getElementById('fechaMovimiento');
        if (!fechaInput.value || fechaInput.value.length !== 10) {
            const val = fechaDTO ? String(fechaDTO).slice(0, 10)
                : new Date().toLocaleDateString("en-CA", { timeZone: "America/Argentina/Buenos_Aires" });
            fechaInput.value = val;
        }

        // Helpers
        function clearTrazasUI() {
            trazasContainer.innerHTML = '';
            trazasHidden.innerHTML = '';
            trazasWrapper.style.display = 'none';
            masterBar.style.display = 'none';
            if (trazasError) trazasError.style.display = 'none';
        }

        function buildTrazaItem(t) {
            // t: TrazaDTO { nroTraza, nroBulto?, ... }
            const id = `traza_${t.nroTraza}`;
            const div = document.createElement('div');
            div.className = 'form-check form-check-inline me-3 mb-2';

            const cb = document.createElement('input');
            cb.type = 'checkbox';
            cb.className = 'form-check-input';
            cb.id = id;
            cb.name = 'nrosTrazasDevolver';
            cb.value = t.nroTraza;
            if (t.nroBulto != null) cb.dataset.bulto = String(t.nroBulto);

            const lb = document.createElement('label');
            lb.className = 'form-check-label';
            lb.setAttribute('for', id);
            lb.textContent = `[${t.nroTraza}]`;

            div.appendChild(cb);
            div.appendChild(lb);
            return div;
        }

        function restoreOrSelectAll(data, preselected) {
            const hasPre = Array.isArray(preselected) && preselected.length > 0;
            if (hasPre) {
                // Intentamos machear nroTraza + (opcional) nroBulto
                preselected.forEach(pt => {
                    let sel = `input[name="nrosTrazasDevolver"][value="${pt.nroTraza}"]`;
                    const cands = trazasContainer.querySelectorAll(sel);
                    if (cands.length === 1) {
                        cands[0].checked = true;
                    } else if (cands.length > 1 && pt.nroBulto != null) {
                        Array.from(cands).find(x => x.dataset.bulto === String(pt.nroBulto))?.setAttribute('checked', true);
                    } else {
                        // fallback por nroTraza
                        cands.forEach(x => x.checked = true);
                    }
                });
            } else {
                // Por defecto, todas seleccionadas
                trazasContainer.querySelectorAll('input[name="nrosTrazasDevolver"]').forEach(cb => cb.checked = true);
            }
            // Sincroniza maestro
            const all = trazasContainer.querySelectorAll('input[name="nrosTrazasDevolver"]');
            masterAll.checked = (all.length > 0) && Array.from(all).every(cb => cb.checked);
        }

        async function loadTrazasPorLote(codLote, preselected) {
            clearTrazasUI();
            if (!codLote) return;

            const url = base + 'trazas/trazas-vendidas/codigoLote/' + encodeURIComponent(codLote);
            try {
                const resp = await fetch(url, { method: 'GET' });
                if (!resp.ok) throw new Error('HTTP ' + resp.status);
                /** @type {Array} */
                const data = await resp.json();

                if (!Array.isArray(data) || data.length === 0) {
                    trazasWrapper.style.display = 'none';
                    return;
                }

                // Maestro seleccionar todas visible
                masterBar.style.display = 'block';

                // Pinta todas las trazas en una sola lista (sin grupos)
                data.forEach(t => trazasContainer.appendChild(buildTrazaItem(t)));

                // Restaurar selección previa o seleccionar todas
                restoreOrSelectAll(data, preselected);

                // Listeners
                masterAll.addEventListener('change', e => {
                    const checked = e.target.checked;
                    trazasContainer.querySelectorAll('input[name="nrosTrazasDevolver"]').forEach(cb => cb.checked = checked);
                });
                trazasContainer.addEventListener('change', e => {
                    if (e.target && e.target.matches('input[name="nrosTrazasDevolver"]')) {
                        const all = trazasContainer.querySelectorAll('input[name="nrosTrazasDevolver"]');
                        masterAll.checked = Array.from(all).every(cb => cb.checked);
                    }
                });

                trazasWrapper.style.display = 'block';
            } catch (e) {
                console.error('Error trazas:', e);
                alert('No se pudieron cargar las trazas vendidas del lote.');
            }
        }

        // Cambio de lote -> carga trazas vendidas
        loteSelect.addEventListener('change', () => {
            const cod = (loteSelect.value || '').trim();
            loadTrazasPorLote(cod, []);
        });

        // Submit: validar selección y construir movimientoDTO.trazaDTOs[index]
        const form = document.querySelector('form');
        form.addEventListener('submit', ev => {
            const checks = trazasContainer.querySelectorAll('input[name="nrosTrazasDevolver"]:checked');
            if (trazasWrapper.style.display !== 'none' && checks.length === 0) {
                ev.preventDefault();
                if (trazasError) {
                    trazasError.style.display = 'block';
                    trazasError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
                return;
            } else if (trazasError) {
                trazasError.style.display = 'none';
            }

            // reconstruir inputs ocultos
            trazasHidden.innerHTML = '';
            const codigoLote = (loteSelect.value || '').trim();
            let idx = 0;
            checks.forEach(cb => {
                const nroTraza = cb.value;
                const nroBulto = cb.dataset.bulto || ''; // opcional, no agrupamos pero lo mandamos si vino

                const h1 = document.createElement('input');
                h1.type = 'hidden';
                h1.name = `trazaDTOs[${idx}].codigoLote`;
                h1.value = codigoLote;
                trazasHidden.appendChild(h1);

                if (nroBulto !== '') {
                    const h2 = document.createElement('input');
                    h2.type = 'hidden';
                    h2.name = `trazaDTOs[${idx}].nroBulto`;
                    h2.value = nroBulto;
                    trazasHidden.appendChild(h2);
                }

                const h3 = document.createElement('input');
                h3.type = 'hidden';
                h3.name = `trazaDTOs[${idx}].nroTraza`;
                h3.value = nroTraza;
                trazasHidden.appendChild(h3);

                idx++;
            });
        });

        // Init: si ya viene lote y trazas del DTO (por errores de validación), restaurar
        if (selectedCodLote) {
            loteSelect.value = selectedCodLote;
            loadTrazasPorLote(selectedCodLote, selectedTrazas || []);
        }

        // foco al primer error si existe
        document.querySelector('.error-field')?.focus();
    });
</script>
</body>
</html>
