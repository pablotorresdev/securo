<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Trazado Unidad de Venta</title>
    <!-- Bootstrap para estilos básicos -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Metadatos CSRF inyectados por Spring Security para proteger POST/PUT/DELETE -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<body>
<div class="container mt-5">
    <h2 class="mb-4">Trazado Unidad de Venta</h2>

    <!--
      Form principal:
      - Método POST contra /ventas/trazado/inicio-trazado
      - th:object vincula los campos al movimientoDTO del backend
    -->
    <form method="post" th:action="@{/ventas/trazado/inicio-trazado}" th:object="${movimientoDTO}">
        <!-- Token CSRF requerido por el backend -->
        <input th:name="${_csrf.parameterName}" th:value="${_csrf.token}" type="hidden"/>

        <hr class="my-4">
        <h5 class="mb-3 text-primary">Datos Obligatorios</h5>

        <!--
          Selector de Lote a Trazar:
          - Bindeado a movimientoDTO.codigoLote
          - Las options muestran información útil (producto, código interno, fechas, rango de trazas)
          - La lógica de negocio (qué lotes aparecen) viene prefiltrada desde el controlador
        -->
        <div class="mb-3">
            <label class="form-label" for="codigoLote">Lote:</label>
            <select class="form-select" id="codigoLote" required th:field="*{codigoLote}">
                <option value="">-- Seleccione un Lote --</option>
                <option th:each="loteDTO : ${loteTrazadoDtos}"
                        th:text="'Producto: ' + ${loteDTO.nombreProducto}
                         + ' | Codigo interno: ' + ${loteDTO.codigoLote}
                         + ' | Fecha ingreso: ' + ${loteDTO.fechaIngreso}"
                        th:value="${loteDTO.codigoLote}">
                </option>
            </select>
        </div>

        <!--
          Fecha del movimiento de trazado:
          - Bindeada a movimientoDTO.fechaMovimiento
          - El script al final setea por defecto la fecha de hoy si viene vacía (TZ Buenos Aires)
          - th:classappend agrega una clase para enfocar el primer campo con error si lo hay
        -->
        <div class="mb-2">
            <label class="form-label" for="fechaMovimiento">Fecha de Cambio de Dictamen:</label>
            <input class="form-control" id="fechaMovimiento"
                   required
                   th:classappend="${#fields.hasErrors('fechaMovimiento')} ? ' error-field' : ''"
                   th:field="*{fechaMovimiento}"
                   type="date">
            <!-- Mensaje de error server-side para la fecha -->
            <div style="color: red; font-weight: bold;"
                 th:errors="*{fechaMovimiento}"
                 th:if="${#fields.hasErrors('fechaMovimiento')}"></div>
        </div>

        <!--
  Traza inicial (solo para productos UNIDAD_VENTA):
  - Visible si data-tipo-producto === 'UNIDAD_VENTA'
  - Se pide para inicializar el rango de trazas generadas
-->
        <div class="mb-2 hidden" id="trazaContainer">
            <label class="form-label" for="trazaInicial">Nro traza inicial:</label>
            <input class="form-control" id="trazaInicial" th:field="*{trazaInicial}" type="number">
            <div class="text-danger fw-bold" th:errors="*{trazaInicial}" th:if="${#fields.hasErrors('trazaInicial')}"></div>
        </div>

        <!--
          Observaciones:
          - Campo opcional para notas adicionales del usuario
          - Bindeado a movimientoDTO.observaciones
        -->
        <div class="mb-3">
            <label class="form-label" for="observaciones">Observaciones (opcional):</label>
            <textarea class="form-control"
                      id="observaciones"
                      rows="2"
                      th:field="*{observaciones}"></textarea>
        </div>

        <!-- Acciones principales de la vista -->
        <div class="d-flex justify-content-between mt-4">
            <a class="btn btn-secondary" th:href="@{/ventas/trazado/cancelar}">Cancelar</a>
            <button class="btn btn-primary" type="submit">Trazar Lote</button>
        </div>
    </form>
</div>

<!-- Pie de página meramente informativo -->
<footer class="text-center mt-4 text-muted">
    <p>&copy; 2025 Conitrack. All rights reserved.</p>
</footer>

<!-- =========================================================
     Script de inicialización de la vista
     - Setea la fecha por defecto si el DTO no la trae
     - Enfoca el primer campo con error si existe
========================================================= -->
<script th:inline="javascript">
    document.addEventListener('DOMContentLoaded', function () {
        // Fecha proveniente del DTO (si el formulario vuelve con errores)
        var fechaMovimientoDTO = /*[[${movimientoDTO.fechaMovimiento}]]*/ [];

        // Si no hay fecha seteada, usar la fecha actual en formato yyyy-MM-dd (en-CA)
        if (fechaMovimientoDTO) {
            document.getElementById("fechaMovimiento").value = fechaMovimientoDTO;
        } else {
            const hoy = new Date();
            const hoyFormateado = hoy.toLocaleDateString("en-CA", { timeZone: "America/Argentina/Buenos_Aires" });
            document.getElementById("fechaMovimiento").value = hoyFormateado;
        }

        // ---------- Mostrar/ocultar campo de Traza según tipo de producto ----------
        function toggleTrazaInput() {
            const selectProd = document.getElementById('productoId');
            const opt        = selectProd.options[selectProd.selectedIndex];
            const tipo       = opt.getAttribute('data-tipo-producto'); // p.ej. 'UNIDAD_VENTA'
            const cont       = document.getElementById('trazaContainer');
            const inp        = document.getElementById('trazaInicial');

            if (tipo === 'UNIDAD_VENTA') {
                cont.classList.remove('hidden');
                inp.required = true;
            } else {
                cont.classList.add('hidden');
                inp.required = false;
                inp.value = '';
            }
        }

        // Al cargar, intenta setear visibilidad correctamente
        toggleTrazaInput();
        // Al cambiar el producto, volver a evaluar
        document.getElementById('productoId').addEventListener('change', toggleTrazaInput);

        // Si hay errores de validación, enfocar el primer campo marcado con .error-field
        const errorField = document.querySelector('.error-field');
        if (errorField) errorField.focus();
    });
</script>
</body>
</html>
